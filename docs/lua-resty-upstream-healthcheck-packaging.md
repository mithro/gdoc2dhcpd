# lua-resty-upstream-healthcheck Debian Packaging

Requirements for creating a Debian package of the
[lua-resty-upstream-healthcheck](https://github.com/openresty/lua-resty-upstream-healthcheck)
library for use with nginx's Lua module.

## Purpose

The `lua-resty-upstream-healthcheck` library enables active health
checking of nginx upstream backends. It probes each backend at a
configurable interval and marks down backends as unavailable, so nginx
stops routing traffic to them before users experience failures.

gdoc2netcfg generates nginx configuration files that use this library
(see `conf.d/healthcheck-init.conf`).

## Source

- **Upstream repo:** https://github.com/openresty/lua-resty-upstream-healthcheck
- **License:** BSD 2-Clause
- **Pure Lua:** Yes (no C compilation needed)

## Install path

The library must be installed to:

```
/usr/share/lua/5.1/resty/upstream/healthcheck.lua
```

This is the standard Lua 5.1 module path on Debian. The nginx config
generated by gdoc2netcfg sets `lua_package_path` to search
`/usr/share/lua/5.1/` by default (configurable via
`lua_healthcheck_path` in `gdoc2netcfg.toml`).

## Dependencies

- **`libnginx-mod-http-lua`** -- provides the `ngx_http_lua_module`
  that implements `init_worker_by_lua_block`, `content_by_lua_block`,
  `lua_shared_dict`, etc.
- **`libnginx-mod-http-lua-upstream`** -- provides the
  `ngx_http_lua_upstream_module` for `ngx.upstream` API access
  (required by the healthcheck library to get/set upstream peer status).

Both are available in the Debian/Ubuntu apt repositories.

## Packaging model

Use `libnginx-mod-http-lua-upstream` as a reference for the package
structure. That package:

- Installs a single `.so` module
- Depends on `nginx-common` and `libnginx-mod-http-lua`
- Ships a module load snippet in `/usr/share/nginx/modules-available/`

For `lua-resty-upstream-healthcheck`, the package is simpler since it's
pure Lua (no compilation):

- Install `healthcheck.lua` to `/usr/share/lua/5.1/resty/upstream/`
- Depend on `libnginx-mod-http-lua` and `libnginx-mod-http-lua-upstream`
- No module load snippet needed (Lua modules are loaded at runtime via
  `require`)

## Verification

After installing, verify the library is loadable:

```bash
# Check file exists
ls -la /usr/share/lua/5.1/resty/upstream/healthcheck.lua

# Test nginx config that uses it
nginx -t
```
